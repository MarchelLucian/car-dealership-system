<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Available Offers</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/client.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
<div class="page-wrapper">

    <!-- Zonă top: Back + Search + Auth (stivuite logic la zoom / ecran mic) -->
    <header class="client-top">
        <a href="/" class="client-back-btn">
            <i class="fa-regular fa-circle-left"></i>
        </a>
        <div class="search-wrapper">
            <input
                    type="text"
                    id="searchInput"
                    class="search-bar"
                    placeholder="Search by Brand, Model or Year..."
                    autocomplete="off"
            />
            <button id="searchBtn" class="search-btn">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
            <div id="autocompleteList" class="autocomplete-list"></div>
        </div>
        <div class="auth-container">
            <div class="avatar">
                <span th:if="${isLogged}" th:text="${clientInitials} "></span>
                <span th:unless="${isLogged}">?</span>
            </div>
            <div class="auth-buttons-vertical" th:unless="${isLogged}">
                <a href="/client-login" class="auth-btn sign-in">Sign In</a>
                <a href="/client-register" class="auth-btn sign-in">Create Account</a>
            </div>
            <div class="auth-buttons-horizontal" th:if="${isLogged}">
                <a href="/client/favorites" class="auth-btn small-btn">
                    <i class="fa-regular fa-heart auth-icon"></i>
                    Favorites
                </a>
                <a href="/client/my-orders" class="auth-btn small-btn">
                    <i class="fa-solid fa-car-side auth-icon"></i>
                    My Purchases
                </a>
                <a href="/client/my-account" class="auth-btn small-btn">
                    <i class="fa-solid fa-circle-info auth-icon"></i>
                    My Account
                </a>
                <a href="/logout" class="auth-btn logout-btn small-btn">
                    <i class="fa-solid fa-door-open auth-icon"></i>
                    Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Left Sidebar -->
    <div class="sidebar">
        <h2>Filters</h2>

        <!-- PRICE -->
        <div class="filter-row">
            <div class="filter-item">
                <label>Minimum Price</label>
                <input id="minPrice" type="number" placeholder="Ex: 5000">
            </div>

            <div class="filter-item">
                <label>Maximum Price</label>
                <input id="maxPrice" type="number" placeholder="Ex: 30000">
            </div>
        </div>

        <!-- YEAR -->
        <div class="filter-row years">
            <div class="filter-item">
                <label>Minimum Year</label>
                <input id="minYear" type="number" placeholder="Ex: 2005">
            </div>

            <div class="filter-item">
                <label>Maximum Year</label>
                <input id="maxYear" type="number" placeholder="Ex: 2024">
            </div>
        </div>

        <!-- MILEAGE -->
        <div class="filter-section mileage">
            <label>Maximum Mileage (km)</label>
            <input id="maxMileage" type="number" placeholder="Ex: 150000">
        </div>


        <!-- BRANDS -->
        <div class="filter-section filter-section-brands">
            <label class=" labelAvailableBrands">Available Brands:</label>
            <div  id="brandsContainer"></div>
            <div class="brands-controls">
                <div id="showMoreBrands" class="show-more-brands">Show more brands...</div>
                <div id="showLessBrands" class="show-less-brands">Show less brands</div>
            </div>
        </div>



        <!-- ADVANCED OPTIONS TOGGLE BUTTON -->
        <div id="advancedToggle" class="advanced-toggle">
            <i class="fa-solid fa-atom"></i>
            Advanced Options
            <span id="advancedArrow">▼</span>
        </div>

        <!-- ADVANCED OPTIONS WRAPPER (HIDDEN BY DEFAULT) -->
        <div id="advancedSection" class="advanced-section">


        <!-- TRANSMISSION -->
        <div class="filter-section transmission-section">
            <label>Transmission Type:</label>

            <div class="filter-inline centered">
                <div>
                    <input type="checkbox"  class="trans-filter" id="trans_manual" value="manuala">
                    <label for="trans_manual" style="font-weight: normal;">Manual</label>
                </div>
                <div>
                    <input type="checkbox" class="trans-filter" id="trans_auto" value="automata">
                    <label for="trans_auto" style="font-weight: normal;">Automatic</label>
                </div>
            </div>
        </div>


        <!-- NUMBER OF DOORS -->
        <div class="filter-section doors-section">
            <label>Number of Doors:</label>

            <div class="filter-inline centered">
                <div>
                    <input type="checkbox" class="door-filter" value="2">
                    <label style="font-weight: normal;">2</label>
                </div>
                <div>
                    <input type="checkbox" class="door-filter" value="4">
                    <label style="font-weight: normal;">4</label>
                </div>
            </div>
        </div>


        <!-- NUMBER OF SEATS -->
        <div class="filter-section">
            <label>Number of Seats:</label>

            <div class="seat-grid">

                <div class="seat-item">
                    <input type="checkbox" class="seat-filter" value="2">
                    <span>2</span>
                </div>

                <div class="seat-item">
                    <input type="checkbox" class="seat-filter" value="4">
                    <span>4</span>
                </div>

                <div class="seat-item">
                    <input type="checkbox" class="seat-filter" value="5">
                    <span>5</span>
                </div>

                <div class="seat-item">
                    <input type="checkbox" class="seat-filter" value="6">
                    <span>6</span>
                </div>

                <!-- ROW 2 -->
                <div class="row2">
                    <div class="seat-item">
                        <input type="checkbox" class="seat-filter" value="7">
                        <span>7</span>
                    </div>

                    <div class="seat-item">
                        <input type="checkbox" class="seat-filter" value="8">
                        <span>8</span>
                    </div>

                    <div class="seat-item">
                        <input type="checkbox" class="seat-filter" value="9">
                        <span>9</span>
                    </div>
                </div>
            </div>

        </div>
        <!-- Type of fuel -->
        <div class="filter-section a">
            <label>Fuel Type:</label>

            <div class="fuel-grid">
                <div class="seat-item">
                    <input type="checkbox" class="fuel-filter" value="benzina">
                    <span>Petrol</span>
                </div>

                <div class="seat-item">
                    <input type="checkbox" class="fuel-filter" value="motorina">
                    <span>Diesel</span>
                </div>

                <div class="seat-item">
                    <input type="checkbox" class="fuel-filter" value="electric">
                    <span>Electric</span>
                </div>

                <div class="seat-item">
                    <input type="checkbox" class="fuel-filter" value="hibrid">
                    <span>Hybrid</span>
                </div>
            </div>
        </div>

        </div>

        <button id="applyFiltersBtn" class="filter-btn">Apply Filters</button>

        <div class="reset-filters" id="resetFilters">Reset Filters</div>

    </div>



    <!-- Main Content -->
    <div class="main-content">
        <h1>Available Offers</h1>
        
        <div id="resultsCount" class="results-count"></div>
        <!-- Sorting Bar -->
        <div class="sort-box">
            <label>Sort by:</label>
            <select id="sortField" class="criteriuSort">
                <option value="pret">Price</option>
                <option value="an">Year</option>
                <option value="kilometraj">Mileage</option>
            </select>

            <select id="sortOrder" class="tipSort">
                <option value="cresc">
                    Ascending
                </option>
                <option value="desc">
                    Descending
                </option>
            </select>

            <button id="sortBtn" class="sort-btn">
                <span>Sort</span>
                <i id="sortIcon" class="fa-solid fa-arrow-down-short-wide"></i>
            </button>

        </div>

        <div id="lista" class="lista-wrapper">
            <div id="listaOverlay" class="lista-overlay" style="display:none;">
                <i class="fa-solid fa-spinner spin-icon"></i>
            </div>

            <div id="listaContent">
                <div th:each="m : ${masini}" class="car-box" th:attr="data-car-id=${m.id}">

                    <!-- Buton Favorite -->
                    <button class="favorite-btn"
                            th:classappend="${favoriteMasinaIds.contains(m.id)} ? 'active' : ''"
                            th:onclick="'toggleFavorite(this, ' + ${m.id} + ')'">
                        <i th:class="${favoriteMasinaIds.contains(m.id)} ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                    </button>

                    <!-- Preț -->
                    <div class="car-price">
                        [[${#numbers.formatInteger(m.pret, 0, 'DEFAULT')}]] €
                    </div>

                    <!-- Header cu Brand & Model -->
                    <div class="car-header">
                        <div class="car-title-section">
                            <!-- Logo - va fi încărcat dinamic -->
                            <img class="car-logo"
                                 th:data-brand="${m.marca}"
                                 src="/images/logos/loading.gif"
                                 alt="Loading logo...">
                            <div>
                                <h3 class="car-title">[[${m.marca}]]</h3>
                                <p class="car-model">[[${m.model}]]</p>
                            </div>
                        </div>
                    </div>


                    <!-- Detalii principale (vizibile mereu) -->
                    <div class="car-main-details">
                        <p>
                            <i class="fa-solid fa-calendar-days"></i>
                            <b>Year:</b> [[${m.an}]]
                        </p>

                        <p>
                            <i class="fa-solid fa-road"></i>
                            <b>Mileage:</b> [[${m.kilometraj}]] km
                        </p>

                        <p>
                            <i class="fa-solid fa-gas-pump"></i>
                            <b>Fuel:</b> [[${m.combustibil}]]
                        </p>

                        <p>
                            <i class="fa-solid fa-gears"></i>
                            <b>Transmission:</b> [[${m.transmisie}]]
                        </p>
                    </div>

                    <!-- GALERIE: 3 stânga | 1 centru | 3 dreapta (click pe margini = centru) -->
                    <div class="car-images-carousel car-images-gallery"
                         th:data-brand="${m.marca}"
                         th:data-model="${m.model}">
                        <div class="car-gallery">
                            <div class="car-gallery-left"></div>
                            <div class="car-gallery-center">
                                <div class="car-gallery-loading">
                                    <i class="fa-solid fa-spinner fa-spin"></i>
                                </div>
                            </div>
                            <div class="car-gallery-right"></div>
                        </div>
                    </div>

                    <!-- "Updated on" dedesubtul imaginilor -->
                    <div class="price-update-badge"
                         th:if="${dateActualizare.containsKey(m.id)}"
                         th:attr="data-update-date=${dateActualizare.get(m.id)}">
                        <i class="fa-regular fa-clock"></i>
                        <span>Loading...</span>
                    </div>

                </div>
            </div>
        </div>




        <button id="loadMore">
            <i class="fa-solid fa-caret-down"></i>
             Load More Offers</button>
        <a href="/" class="back-btn">
            <i class="fa-solid fa-person-walking-arrow-loop-left"></i>
            Back to Home</a>
    </div>
</div>

<!-- Popup "Sign in to add favorites" (în loc de alert) -->
<div id="signInRequiredOverlay" class="client-signin-overlay" style="display: none;">
    <div class="client-signin-popup">
        <div class="client-signin-icon">
            <i class="fa-solid fa-heart-circle-exclamation"></i>
        </div>
        <h3 class="client-signin-title">Sign in required</h3>
        <p class="client-signin-message">Please sign in to add favorites!</p>
        <div class="client-signin-buttons">
            <button type="button" class="client-signin-btn client-signin-btn-ok" id="signInRequiredOk">OK</button>
            <a href="/client-login" class="client-signin-btn client-signin-btn-primary">Sign In</a>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // Trimite favoriteMasinaIds la JavaScript
    const favoriteMasinaIds = /*[[${favoriteMasinaIds}]]*/ [];

    const dateActualizareMap = /*[[${dateActualizare}]]*/ {};

</script>
<script th:src="@{/js/client.js}"></script>
</body>
</html>
